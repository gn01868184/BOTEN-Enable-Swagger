<!DOCTYPE html>
<html lang="en">

<head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">
  <!-- Bootstrap 4 Icons -->
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.0/css/all.css" integrity="sha384-lZN37f5QGtY3VHgisS14W3ExzMWZxybE1SJSEsQp9S+oqd12jhcu+A56Ebc1zFSJ" crossorigin="anonymous">
  <!-- jQuery -->
  <script type="text/javascript" src="https://code.jquery.com/jquery-3.3.1.js"></script>
  <title>Boten Bot</title>
</head>

<body>
  <nav class="navbar navbar-expand-lg navbar-light  bg-primary">
    <a class="navbar-brand  text-light" href="./index.html"><span class="fas fa-robot"></span>&nbsp;Boten Bot</a>
  </nav>
  <div class="container-fluid">
    <div class="card">
      <div class="row">
        <div class="col-12">
          <div class="card-body" id="reponse">
            <div class="row">
              <H3 style="font-family: monospace;" class="col-3">Know your location</H3>
              <button type="button" class="btn btn-outline-primary" id="allowLocation">Allow</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <form id="inputForm">
      <div class="row">
        <textarea class="col-9 form-control" name="userInput" id="userInput" rows="3"></textarea>
        <button type="submit" class="col-3 btn btn-primary">Submit</button>
      </div>
    </form>
  </div>
  <script>
    $(document).ready(function() {
      $("#inputForm").submit(function(e) {
        var userInput = document.getElementById("userInput").value;
        ajaxFunction(userInput);
        e.preventDefault(); // avoid to execute the actual submit of the form.
      });

      $("#allowLocation").click(function() {
        var options = {
          enableHighAccuracy: true,
          timeout: 5000,
          maximumAge: 0
        };

        function success(pos) {
          var crd = pos.coords;

          console.log('Your current position is:');
          console.log('Latitude : ' + crd.latitude);
          console.log('Longitude: ' + crd.longitude);
          var userInput = "Latitude of my current location is " + crd.latitude + ", longitude of my current location is " + crd.longitude;
          ajaxFunction(userInput);
        };

        function error(err) {
          console.warn('ERROR(' + err.code + '): ' + err.message);
          $('#reponse').append(
            '<div class="row"><p style = "font-family: monospace;">user: ERROR(' + err.code + '): ' + err.message + '</p></div>'
          );
        };

        navigator.geolocation.getCurrentPosition(success, error, options);
      });

      function ajaxFunction(userInput) {
        var reqData = {
          "sender": "Rasa",
          "message": userInput
        }
        $('#reponse').append(
          '<div class="row"><p style = "font-family: monospace;">user: ' + userInput + '</p></div>'
        );
        console.log(reqData);
        $.ajax({
          type: "POST",
          url: 'http://localhost:5005/webhooks/rest/webhook',
          dataType: 'json',
          data: JSON.stringify(reqData),
          success: function(data) {
            console.log(data);
            data.forEach(function(value, index, array) {
              let idList = Object.keys(data[index]);
              idList.forEach(function(dataValue) {
                if (dataValue == 'text') {
                  var output = data[index]['text'];
                  // json beautify
                  if (isJsonString(output) == true) {
                    var tmpData = JSON.parse(data[index]['text']);
                    console.log(tmpData);
                    if (tmpData['message'] == null) {
                      var random = getRandomInt(10000);
                      $('#reponse').append('<div id=' + random + '><table class="table"><thead></thead><tbody></tbody></table></div>');
                      $(tmpData['thead']).each(function(k, v) {
                        $('#' + random + ' table thead').append(
                          '<th scope="col">' + v + '</th>'
                        );
                      });
                      $(tmpData['tbody']).each(function() {
                        $(this).each(function(k, v) {
                          $('#' + random + ' table tbody').append('<tr></tr>');
                          $('#' + random + ' table tbody tr:nth-child(' + (k + 1) + ')').append(
                            '<th scope="col">' + v + '</th>'
                          );
                        });
                      });
                    } else {
                      $('#reponse').append('<div class="row"><p style = "font-family: monospace;">bot: ' + tmpData['message'] + '</p></div>');
                    }
                  } else {
                    $('#reponse').append('<div class="row"><p style = "font-family: monospace;">bot: ' + output + '</p></div>');
                  }
                }
              });
            });
            document.getElementById("userInput").value = "";
          }
        });
      }
      //is json?
      function isJsonString(str) {
        try {
          if (typeof JSON.parse(str) == "object") {
            return true;
          }
        } catch (e) {}
        return false;
      }

      function getRandomInt(max) {
        return Math.floor(Math.random() * Math.floor(max));
      }
    });
  </script>
  <!-- Optional JavaScript -->
  <!-- jQuery first, then Popper.js, then Bootstrap JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js" integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut" crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV" crossorigin="anonymous"></script>
</body>

</html>
